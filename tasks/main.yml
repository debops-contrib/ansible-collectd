---

- name: Install required packages
  apt:
    name: '{{ item }}'
    state: 'present'
    install_recommends: False
  with_flattened:
    - collectd_packages_base
    - collectd_packages

- name: Make sure /etc/collectd and /etc/collectd/collectd.conf.d exists
  file:
    path: '{{ item }}'
    state: 'directory'
    owner: 'root'
    group: 'root'
    mode: '0750'
  with_items:
    - '/etc/collectd'
    - '/etc/collectd/collectd.conf.d'

- name: Check if nginx is installed
  stat:
    path: '/etc/nginx/sites-available'
  register: collectd_register_nginxdir

- name: Check if nginx plugin should be enabled
  set_fact:
    collectd_register_enable_nginx: '{{ collectd_register_nginxdir.stat.exists and collectd_nginx_autodetect is defined and collectd_nginx_autodetect }}'

- name: Install config file
  template:
    src: '{{ item }}.j2'
    dest: '/{{ item }}'
    owner: 'root'
    group: 'root'
    mode: '0640'
  with_items:
    - 'etc/collectd/collectd.conf'
  notify: [ 'Restart collectd' ]
